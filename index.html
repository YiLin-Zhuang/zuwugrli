<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§Ÿå±‹å°å¹«æ‰‹</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <style>
      body { background-color: #f8f9fa; padding: 20px; }
      .card { margin-bottom: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
      #loading { text-align: center; margin-top: 50px; }
      #content { display: none; }
    </style>
  </head>
  <body>
    
    <div id="loading">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2">æ­£åœ¨è®€å–è³‡æ–™...</p>
    </div>

    <div id="content" class="container">
      
      <div id="unregistered-view" style="display:none;">
        <div class="card shadow-sm">
          <div class="card-body">
            <h4 class="card-title text-center mb-4">ğŸ  ç§Ÿå®¢èº«ä»½ç¶å®š</h4>
            <form id="bind-form" onsubmit="submitBinding(event)">
              <div class="mb-3">
                <label class="form-label">æ‰‹æ©Ÿè™Ÿç¢¼</label>
                <input type="tel" class="form-control" id="input-phone" required>
              </div>
              <div class="mb-3">
                <label class="form-label">é©—è­‰ç¢¼</label>
                <input type="text" class="form-control" id="input-code" required>
              </div>
              <button type="submit" id="btn-bind" class="btn btn-primary w-100">ç¢ºèªç¶å®š</button>
            </form>
            <div id="bind-msg" class="mt-3 text-center text-danger"></div>
          </div>
        </div>
      </div>

      <div id="dashboard-view" style="display:none;">
        <h4 id="welcome-msg">å—¨ï¼Œç§Ÿå®¢</h4>
        <div class="card text-white bg-primary">
          <div class="card-body text-center">
            <h6 class="card-title">æœ¬æœˆå¾…ç¹³ç¸½é¡</h6>
            <h1 class="display-4 fw-bold">$<span id="total-due">0</span></h1>
            <p id="bill-status-text">ç‹€æ³è‰¯å¥½</p>
          </div>
        </div>
        <h5 class="mt-4">å¾…è™•ç†å¸³å–®</h5>
        <div id="bill-list"></div>
      </div>
    </div>

    <div id="admin-view" style="display:none;" class="mt-5 pt-3 border-top">
        <h5 class="text-secondary">ğŸ”§ æˆ¿æ±ç®¡ç†å€</h5>
        <div class="card bg-light">
          <div class="card-body">
            <h6>å¿«é€ŸæŠ„è¡¨é–‹å–®</h6>
            <form onsubmit="submitBill(event)">
              <div class="row g-2">
                <div class="col-4">
                  <input type="text" class="form-control" id="bill-room" placeholder="æˆ¿è™Ÿ(201)" required>
                </div>
                <div class="col-8">
                   <input type="month" class="form-control" id="bill-period" required>
                </div>
                <div class="col-6">
                  <input type="number" class="form-control" id="bill-elec" placeholder="æœ¬æœˆé›»åº¦" required>
                </div>
                <div class="col-6">
                  <input type="number" class="form-control" id="bill-water" placeholder="æœ¬æœˆæ°´åº¦" required>
                </div>
                <div class="col-12 mt-2">
                  <button type="submit" id="btn-create-bill" class="btn btn-dark w-100">ç”Ÿæˆå¸³å–®</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>

    <script>
      // âš ï¸ è¨­å®šå€ï¼šè«‹å¡«å…¥ä½ çš„è³‡æ–™
      const LIFF_ID = '2008820485-VKMYnG7d'; 
      const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwRfFmfqVKSHMSHpGaqPFy9x8PLkFSf7cYuoyiFFtKFNA8ojXGtnkRUDWmMsft_MlP_/exec'; 
      // ä¾‹å¦‚: https://script.google.com/macros/s/xxxxxx/exec

      window.onload = function() {
        initializeLiff();
      };

      function initializeLiff() {
        liff.init({ liffId: LIFF_ID })
          .then(() => {
            if (!liff.isLoggedIn()) {
              // å› ç‚ºæ˜¯è‡ªæ¶ç«™ï¼ŒredirectUri è¦å¡«ã€Œä½ è‡ªå·±ç¶²ç«™çš„ç¶²å€ã€
              liff.login({ redirectUri: window.location.href });
            } else {
              const profile = liff.getDecodedIDToken();
              if(profile) fetchUserData(profile.sub);
            }
          })
          .catch(err => alert('LIFF Init Error: ' + err));
      }

      // --- æ”¹ç”¨ fetch å‘¼å« API ---

      // 1. å–å¾—è³‡æ–™ (GET)
      function fetchUserData(lineUserId) {
        // çµ„åˆ URL åƒæ•¸
        const url = `${GAS_API_URL}?action=getStatus&userId=${lineUserId}`;
        
        fetch(url)
          .then(res => res.json()) // è§£æ JSON
          .then(data => {
            renderData(data);
          })
          .catch(err => {
            document.getElementById('loading').style.display = 'none';
            alert("é€£ç·šéŒ¯èª¤ï¼š" + err);
          });
      }

      // 2. æäº¤ç¶å®š (POST)
      function submitBinding(event) {
        event.preventDefault();
        const btn = document.getElementById('btn-bind');
        const msgDiv = document.getElementById('bind-msg');
        btn.disabled = true;
        btn.innerText = "è™•ç†ä¸­...";

        const payload = {
            action: "bind",
            userId: liff.getDecodedIDToken().sub,
            phone: document.getElementById('input-phone').value,
            code: document.getElementById('input-code').value
        };

        // GAS çš„ POST æ¯”è¼ƒç‰¹æ®Šï¼Œå»ºè­°ç”¨ "no-cors" æˆ–è€…ä¸€èˆ¬çš„ POST
        // æ³¨æ„ï¼šGAS Web App æœƒå›å‚³ 302 Redirectï¼Œfetch æœƒè‡ªå‹•è·Ÿéš¨
        fetch(GAS_API_URL, {
            method: 'POST',
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(result => {
            if (result.success) {
                alert("ç¶å®šæˆåŠŸï¼");
                location.reload(); // é‡æ–°æ•´ç†é é¢
            } else {
                msgDiv.innerText = result.message;
                btn.disabled = false;
                btn.innerText = "ç¢ºèªç¶å®š";
            }
        })
        .catch(err => {
            msgDiv.innerText = "API éŒ¯èª¤: " + err;
            btn.disabled = false;
            btn.innerText = "ç¢ºèªç¶å®š";
        });
      }

      // æ¸²æŸ“ç•«é¢ (è·Ÿä¹‹å‰ä¸€æ¨£)
// æ¸²æŸ“ç•«é¢ä¸»å‡½å¼
      function renderData(response) {
        // 1. éš±è—è®€å–å‹•ç•«ï¼Œé¡¯ç¤ºå…§å®¹å€
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';

        // 2. åˆ¤æ–·æ˜¯å¦å·²ç¶å®š
        if (!response.registered) {
          // --- æƒ…æ³ A: æœªç¶å®š ---
          // é¡¯ç¤ºç¶å®šè¡¨å–®ï¼Œéš±è—å„€è¡¨æ¿
          document.getElementById('unregistered-view').style.display = 'block';
          document.getElementById('dashboard-view').style.display = 'none';
        } else {
          // --- æƒ…æ³ B: å·²ç¶å®š (æ­£å¸¸ç§Ÿå®¢) ---
          document.getElementById('unregistered-view').style.display = 'none';
          document.getElementById('dashboard-view').style.display = 'block';
          
          // 2.1 å¡«å…¥ç§Ÿå®¢åŸºæœ¬è³‡æ–™
          // response.tenant æ˜¯å¾Œç«¯å›å‚³çš„ç‰©ä»¶
          const tenantName = response.tenant.name || "ç§Ÿå®¢";
          const roomName = response.tenant.room_id || "æœªçŸ¥æˆ¿è™Ÿ";
          document.getElementById('welcome-msg').innerText = `å—¨ï¼Œ${tenantName} (${roomName}æˆ¿)`;
          document.getElementById('total-due').innerText = response.total_due;

          // 2.2 æ¸²æŸ“å¸³å–®åˆ—è¡¨
          const billList = document.getElementById('bill-list');
          billList.innerHTML = ""; // å…ˆæ¸…ç©ºèˆŠè³‡æ–™

          if (response.bills.length === 0) {
             // ç„¡å¸³å–®æ™‚çš„é¡¯ç¤º
             billList.innerHTML = `
               <div class="text-center py-4">
                 <p class="text-muted mb-0">ğŸ‰ å¤ªæ£’äº†ï¼Œç›®å‰æ²’æœ‰å¾…ç¹³å¸³å–®ï¼</p>
               </div>`;
             document.getElementById('bill-status-text').innerText = "ç›®å‰ç¹³è²»ç‹€æ³è‰¯å¥½";
             // å¦‚æœæ²’æœ‰æ¬ æ¬¾ï¼Œç¸½é‡‘é¡é¡¯ç¤ºç¶ è‰²æˆ–é è¨­è‰²
             document.getElementById('total-due').classList.remove('text-danger');
          } else {
             // æœ‰å¸³å–®æ™‚çš„é¡¯ç¤º
             document.getElementById('bill-status-text').innerText = "æ‚¨æœ‰æœªçµæ¸…çš„å¸³å–®";
             document.getElementById('total-due').classList.add('text-danger'); // é‡‘é¡è®Šç´…è‰²

             response.bills.forEach(bill => {
               // åˆ¤æ–·ç‹€æ…‹é¡¯ç¤ºæ–‡å­—èˆ‡é¡è‰²
               const isUnpaid = bill.status === 'UNPAID';
               const statusText = isUnpaid ? 'æœªç¹³è²»' : 'å¯©æ ¸ä¸­';
               const statusBadgeClass = isUnpaid ? 'bg-danger' : 'bg-warning text-dark';
               
               // ç”¢ç”Ÿæ¯å¼µå¸³å–®çš„ HTML å¡ç‰‡
               const item = document.createElement('div');
               item.className = 'card border-0 shadow-sm mb-3'; // åŠ ä¸€é»é™°å½±èˆ‡é‚Šè·
               item.innerHTML = `
                 <div class="card-body d-flex justify-content-between align-items-center">
                   <div>
                     <h6 class="mb-1 fw-bold">${bill.period} å¸³å–®</h6>
                     <span class="badge ${statusBadgeClass}">${statusText}</span>
                   </div>
                   <div class="text-end">
                     <h5 class="mb-1 text-danger fw-bold">$${bill.total_amt}</h5>
                     ${isUnpaid ? `<button class="btn btn-sm btn-outline-primary mt-1" onclick="uploadProof('${bill.bill_id}')">ä¸Šå‚³è­‰æ˜</button>` : ''}
                   </div>
                 </div>
               `;
               billList.appendChild(item);
             });
          }

          // 3. è™•ç†æˆ¿æ±ç®¡ç†å€ (Admin View)
          // é‚è¼¯ï¼šå¦‚æœä½ å¸Œæœ›è®“ç‰¹å®šçš„äººçœ‹åˆ°å¾Œå°ï¼Œå¯ä»¥æ¯”å° ID
          // ç›®å‰ç‚ºäº†è®“ä½ æ–¹ä¾¿æ¸¬è©¦ï¼Œæˆ‘å€‘ç›´æ¥è¨­å®šã€Œåªè¦ç¶å®šæˆåŠŸå°±é¡¯ç¤ºã€
          // æˆ–è€…ä½ å¯ä»¥æŠŠ const isAdmin = true æ”¹æˆ false ä¾†éš±è—
          
          const currentUserId = liff.getDecodedIDToken().sub;
          
          // TODO: æœªä¾†å»ºè­°å¾Œç«¯ API ç›´æ¥å›å‚³ isAdmin: true/false æ¯”è¼ƒå®‰å…¨
          // é€™è£¡æˆ‘å€‘å…ˆåšä¸€å€‹ç°¡å–®çš„ã€Œå‰ç«¯æ¸¬è©¦é–‹é—œã€
          const isAdmin = true; // â˜… æƒ³éš±è—å¾Œå°å°±æŠŠé€™è£¡æ”¹æˆ false

          if (isAdmin) {
             const adminView = document.getElementById('admin-view');
             if(adminView) {
               adminView.style.display = 'block';
               
               // è‡ªå‹•å¡«å…¥ã€Œæœ¬æœˆã€åˆ°è¼¸å…¥æ¡†ï¼Œæ–¹ä¾¿æ“ä½œ
               const now = new Date();
               // æ ¼å¼åŒ–æˆ YYYY-MM
               const monthStr = now.toISOString().slice(0, 7); 
               document.getElementById('bill-period').value = monthStr;
             }
          }
        }
      }

      // [é¡å¤–è£œå……] é€™æ˜¯ä¸Šå‚³è­‰æ˜çš„é ç•™å‡½å¼ (é¿å…å ±éŒ¯)
      function uploadProof(billId) {
        alert("ä¸Šå‚³åŠŸèƒ½é–‹ç™¼ä¸­... (Bill ID: " + billId + ")");
      }
    </script>
  </body>
</html>