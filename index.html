<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§Ÿå±‹å°å¹«æ‰‹</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <style>
      body { background-color: #f8f9fa; padding: 20px; }
      .card { margin-bottom: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
      #loading { text-align: center; margin-top: 50px; }
      #content { display: none; }
    </style>
  </head>
  <body>
    
    <div id="loading">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2">æ­£åœ¨è®€å–è³‡æ–™...</p>
    </div>

    <div id="content" class="container">
      
      <div id="unregistered-view" style="display:none;">
        <div class="card shadow-sm">
          <div class="card-body">
            <h4 class="card-title text-center mb-4">ğŸ  ç§Ÿå®¢èº«ä»½ç¶å®š</h4>
            <form id="bind-form" onsubmit="submitBinding(event)">
              <div class="mb-3">
                <label class="form-label">æ‰‹æ©Ÿè™Ÿç¢¼</label>
                <input type="tel" class="form-control" id="input-phone" required>
              </div>
              <div class="mb-3">
                <label class="form-label">é©—è­‰ç¢¼</label>
                <input type="text" class="form-control" id="input-code" required>
              </div>
              <button type="submit" id="btn-bind" class="btn btn-primary w-100">ç¢ºèªç¶å®š</button>
            </form>
            <div id="bind-msg" class="mt-3 text-center text-danger"></div>
          </div>
        </div>
      </div>

      <div id="dashboard-view" style="display:none;">
        <h4 id="welcome-msg">å—¨ï¼Œç§Ÿå®¢</h4>
        <div class="card text-white bg-primary">
          <div class="card-body text-center">
            <h6 class="card-title">æœ¬æœˆå¾…ç¹³ç¸½é¡</h6>
            <h1 class="display-4 fw-bold">$<span id="total-due">0</span></h1>
            <p id="bill-status-text">ç‹€æ³è‰¯å¥½</p>
          </div>
        </div>
        <h5 class="mt-4">å¾…è™•ç†å¸³å–®</h5>
        <div id="bill-list"></div>
      </div>
    </div>

    <script>
      // âš ï¸ è¨­å®šå€ï¼šè«‹å¡«å…¥ä½ çš„è³‡æ–™
      const LIFF_ID = '2008820485-VKMYnG7d'; 
      const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwRfFmfqVKSHMSHpGaqPFy9x8PLkFSf7cYuoyiFFtKFNA8ojXGtnkRUDWmMsft_MlP_/exec'; 
      // ä¾‹å¦‚: https://script.google.com/macros/s/xxxxxx/exec

      window.onload = function() {
        initializeLiff();
      };

      function initializeLiff() {
        liff.init({ liffId: LIFF_ID })
          .then(() => {
            if (!liff.isLoggedIn()) {
              // å› ç‚ºæ˜¯è‡ªæ¶ç«™ï¼ŒredirectUri è¦å¡«ã€Œä½ è‡ªå·±ç¶²ç«™çš„ç¶²å€ã€
              liff.login({ redirectUri: window.location.href });
            } else {
              const profile = liff.getDecodedIDToken();
              if(profile) fetchUserData(profile.sub);
            }
          })
          .catch(err => alert('LIFF Init Error: ' + err));
      }

      // --- æ”¹ç”¨ fetch å‘¼å« API ---

      // 1. å–å¾—è³‡æ–™ (GET)
      function fetchUserData(lineUserId) {
        // çµ„åˆ URL åƒæ•¸
        const url = `${GAS_API_URL}?action=getStatus&userId=${lineUserId}`;
        
        fetch(url)
          .then(res => res.json()) // è§£æ JSON
          .then(data => {
            renderData(data);
          })
          .catch(err => {
            document.getElementById('loading').style.display = 'none';
            alert("é€£ç·šéŒ¯èª¤ï¼š" + err);
          });
      }

      // 2. æäº¤ç¶å®š (POST)
      function submitBinding(event) {
        event.preventDefault();
        const btn = document.getElementById('btn-bind');
        const msgDiv = document.getElementById('bind-msg');
        btn.disabled = true;
        btn.innerText = "è™•ç†ä¸­...";

        const payload = {
            action: "bind",
            userId: liff.getDecodedIDToken().sub,
            phone: document.getElementById('input-phone').value,
            code: document.getElementById('input-code').value
        };

        // GAS çš„ POST æ¯”è¼ƒç‰¹æ®Šï¼Œå»ºè­°ç”¨ "no-cors" æˆ–è€…ä¸€èˆ¬çš„ POST
        // æ³¨æ„ï¼šGAS Web App æœƒå›å‚³ 302 Redirectï¼Œfetch æœƒè‡ªå‹•è·Ÿéš¨
        fetch(GAS_API_URL, {
            method: 'POST',
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(result => {
            if (result.success) {
                alert("ç¶å®šæˆåŠŸï¼");
                location.reload(); // é‡æ–°æ•´ç†é é¢
            } else {
                msgDiv.innerText = result.message;
                btn.disabled = false;
                btn.innerText = "ç¢ºèªç¶å®š";
            }
        })
        .catch(err => {
            msgDiv.innerText = "API éŒ¯èª¤: " + err;
            btn.disabled = false;
            btn.innerText = "ç¢ºèªç¶å®š";
        });
      }

      // æ¸²æŸ“ç•«é¢ (è·Ÿä¹‹å‰ä¸€æ¨£)
      function renderData(response) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';

        if (!response.registered) {
          document.getElementById('unregistered-view').style.display = 'block';
        } else {
          document.getElementById('dashboard-view').style.display = 'block';
          document.getElementById('welcome-msg').innerText = `å—¨ï¼Œ${response.tenant.name} (${response.tenant.room_id}æˆ¿)`;
          document.getElementById('total-due').innerText = response.total_due;

          const billList = document.getElementById('bill-list');
          billList.innerHTML = "";
          if (response.bills.length === 0) {
             billList.innerHTML = '<p class="text-muted">ç„¡å¾…ç¹³å¸³å–®ã€‚</p>';
          } else {
             document.getElementById('bill-status-text').innerText = "æ‚¨æœ‰æœªçµæ¸…çš„å¸³å–®";
             response.bills.forEach(bill => {
               billList.innerHTML += `
                 <div class="card"><div class="card-body d-flex justify-content-between">
                   <div><h6>${bill.period}</h6><small>${bill.status}</small></div>
                   <h5 class="text-danger">$${bill.total_amt}</h5>
                 </div></div>`;
             });
          }
        }
      }
    </script>
  </body>
</html>