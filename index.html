<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„å¸³å–®</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .bill-card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-top: 20px; }
        .bill-header { padding: 20px; text-align: center; color: white; }
        .header-red { background: linear-gradient(135deg, #ff6b6b, #ee5253); } /* å¾…ç¹³è²» */
        .header-yellow { background: linear-gradient(135deg, #feca57, #ff9f43); color: #333; } /* å¾…æŸ¥æ ¸ */
        .header-green { background: linear-gradient(135deg, #1dd1a1, #10ac84); } /* å·²å®Œæˆ */
        
        .bill-table th { color: #888; font-weight: normal; font-size: 0.9rem; }
        .bill-table td { text-align: right; font-weight: 500; }
        .total-row td { border-top: 2px solid #eee; font-weight: bold; font-size: 1.2rem; color: #333; padding-top: 15px; }
        
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-secondary">è³‡æ–™è®€å–ä¸­...</p>
    </div>

    <div class="container pb-5" id="app" style="display:none;">
        
        <div id="view-bind" style="display:none;">
            <div class="card shadow-sm mt-5">
                <div class="card-body p-4 text-center">
                    <h4>ğŸ‘‹ æ­¡è¿ä¾†åˆ°ç§Ÿå±‹ç®¡ç†</h4>
                    <p class="text-muted mb-4">è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼ä»¥é€£çµæ‚¨çš„ç§Ÿå±‹è³‡æ–™</p>
                    <input type="tel" id="input-phone" class="form-control form-control-lg mb-3 text-center" placeholder="0912345678">
                    <button onclick="doBind()" class="btn btn-primary btn-lg w-100" id="btn-bind">ç¢ºèªç¶å®š</button>
                </div>
            </div>
        </div>

        <div id="view-bill" style="display:none;">
            <div class="bill-card">
                <div id="bill-header" class="bill-header header-red">
                    <h3 id="bill-month" class="mb-0">2026/01 å¸³å–®</h3>
                    <span id="bill-status" class="badge bg-white text-dark mt-2">å¾…ç¹³è²»</span>
                </div>

                <div class="p-4">
                    <table class="table table-borderless bill-table">
                        <tbody>
                            <tr>
                                <th scope="row">ğŸ  ç¤¾å€æˆ¿è™Ÿ</th>
                                <td id="txt-community">å¹¸ç¦A</td>
                            </tr>
                            <tr>
                                <th scope="row">ğŸ‘¤ æ‰¿ç§Ÿäºº</th>
                                <td id="txt-name">ç‹å°æ˜</td>
                            </tr>
                            <tr><td colspan="2"><hr class="my-1"></td></tr>
                            <tr>
                                <th scope="row">æœ¬æœˆæˆ¿ç§Ÿ</th>
                                <td id="val-rent">$15,000</td>
                            </tr>
                            <tr>
                                <th scope="row">ğŸ’§ æ°´è²» <small class="text-muted" id="usage-water">(20åº¦)</small></th>
                                <td id="val-water">$300</td>
                            </tr>
                            <tr>
                                <th scope="row">âš¡ é›»è²» <small class="text-muted" id="usage-elec">(150åº¦)</small></th>
                                <td id="val-elec">$750</td>
                            </tr>
                            <tr class="total-row">
                                <th scope="row" class="pt-3">æ‡‰ç¹³ç¸½é‡‘é¡</th>
                                <td class="pt-3 text-danger" id="val-total">$16,050</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="mt-4">
                        <button id="btn-pay" onclick="doPay()" class="btn btn-danger btn-lg w-100 shadow-sm">
                            ğŸ’° æˆ‘å·²è½‰å¸³ç¹³è²»
                        </button>
                        <div id="msg-review" class="alert alert-warning text-center mt-3" style="display:none;">
                            â³ å·²é€šçŸ¥æˆ¿æ±ï¼Œè«‹ç­‰å¾…æŸ¥æ ¸ã€‚
                        </div>
                        <div id="msg-done" class="alert alert-success text-center mt-3" style="display:none;">
                            âœ… æˆ¿æ±å·²æŸ¥æ”¶ï¼Œæ„Ÿè¬æº–æ™‚ç¹³æ¬¾ï¼
                        </div>
                    </div>
                </div>
            </div>
            
            <p class="text-center text-muted mt-3 small">è³‡æ–™æ›´æ–°æ™‚é–“: <span id="txt-updated">--</span></p>
        </div>
        
        <div id="view-empty" style="display:none;" class="text-center mt-5">
            <div class="alert alert-light">ç›®å‰æ²’æœ‰å¾…ç¹³å¸³å–® ğŸ‰</div>
        </div>

    </div>

<script>
    // âš ï¸ å¡«å…¥ä½ çš„è¨­å®š
    const LIFF_ID = "2008820485-VKMYnG7d";
    const API_URL = "https://script.google.com/macros/s/AKfycbwRfFmfqVKSHMSHpGaqPFy9x8PLkFSf7cYuoyiFFtKFNA8ojXGtnkRUDWmMsft_MlP_/exec"; 

    let currentBillId = null;
    let currentUser = null;

    window.onload = function() {
        liff.init({ liffId: LIFF_ID }).then(() => {
            if (!liff.isLoggedIn()) {
                liff.login({ redirectUri: window.location.href });
            } else {
                currentUser = liff.getDecodedIDToken().sub;
                fetchStatus();
            }
        });
    };

    function fetchStatus() {
        fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({ action: "getStatus", userId: currentUser })
        })
        .then(r => r.json())
        .then(res => {
            document.getElementById("loading").style.display = "none";
            document.getElementById("app").style.display = "block";

            if (!res.registered) {
                document.getElementById("view-bind").style.display = "block";
            } else {
                if (res.bill) {
                    renderBill(res.tenant, res.bill);
                } else {
                    document.getElementById("view-empty").style.display = "block";
                }
            }
        });
    }

    function renderBill(tenant, bill) {
        document.getElementById("view-bill").style.display = "block";
        currentBillId = bill.bill_id;

        // å¡«å…¥æ–‡å­—
        document.getElementById("txt-community").innerText = tenant.community_id;
        document.getElementById("txt-name").innerText = tenant.name;
        document.getElementById("bill-month").innerText = bill.month + " å¸³å–®";
        
        document.getElementById("val-rent").innerText = "$" + formatMoney(bill.rent);
        document.getElementById("val-water").innerText = "$" + formatMoney(bill.water_amt);
        document.getElementById("usage-water").innerText = `(${bill.water_usage}åº¦)`;
        document.getElementById("val-elec").innerText = "$" + formatMoney(bill.elec_amt);
        document.getElementById("usage-elec").innerText = `(${bill.elec_usage}åº¦)`;
        document.getElementById("val-total").innerText = "$" + formatMoney(bill.total);

        // ç‹€æ…‹æ§åˆ¶ (ğŸ”´å¾…ç¹³è²» / ğŸŸ¡å¾…æŸ¥æ ¸ / ğŸŸ¢å·²å®Œæˆ)
        const header = document.getElementById("bill-header");
        const statusBadge = document.getElementById("bill-status");
        const btnPay = document.getElementById("btn-pay");
        const msgReview = document.getElementById("msg-review");
        const msgDone = document.getElementById("msg-done");

        // é‡ç½®æ¨£å¼
        header.className = "bill-header";
        btnPay.style.display = "none";
        msgReview.style.display = "none";
        msgDone.style.display = "none";

        if (bill.status === "å¾…ç¹³è²»") {
            header.classList.add("header-red");
            statusBadge.innerText = "å¾…ç¹³è²»";
            btnPay.style.display = "block"; // åªæœ‰é€™æ™‚å€™å¯ä»¥æŒ‰
        } else if (bill.status === "å¾…æŸ¥æ ¸") {
            header.classList.add("header-yellow");
            statusBadge.innerText = "å¯©æ ¸ä¸­";
            msgReview.style.display = "block";
        } else if (bill.status === "å·²å®Œæˆ") {
            header.classList.add("header-green");
            statusBadge.innerText = "å·²å®Œæˆ";
            msgDone.style.display = "block";
        }
    }

    function doBind() {
        const phone = document.getElementById("input-phone").value;
        if(!phone) return alert("è«‹è¼¸å…¥æ‰‹æ©Ÿ");
        
        document.getElementById("btn-bind").innerText = "ç¶å®šä¸­...";
        fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({ action: "bind", userId: currentUser, phone: phone })
        }).then(r=>r.json()).then(res => {
            if(res.success) {
                alert("ç¶å®šæˆåŠŸï¼");
                location.reload();
            } else {
                alert(res.message);
                document.getElementById("btn-bind").innerText = "ç¢ºèªç¶å®š";
            }
        });
    }

    function doPay() {
        if(!confirm("ç¢ºå®šå·²å®Œæˆè½‰å¸³ï¼Ÿ")) return;
        
        document.getElementById("btn-pay").innerText = "è™•ç†ä¸­...";
        document.getElementById("btn-pay").disabled = true;

        fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({ action: "pay", userId: currentUser, billId: currentBillId })
        }).then(r=>r.json()).then(res => {
            if(res.success) {
                alert("å·²é€šçŸ¥æˆ¿æ±æŸ¥æ”¶ï¼");
                location.reload(); // é‡æ–°æ•´ç†çœ‹ç‹€æ…‹è®ŠåŒ–
            } else {
                alert("éŒ¯èª¤ï¼š" + res.message);
            }
        });
    }

    function formatMoney(num) {
        return Number(num).toLocaleString();
    }
</script>
</body>
</html>