<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„å¸³å–®ç´€éŒ„</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: sans-serif; padding-bottom: 50px; }
        .bill-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* ç‹€æ…‹æ¢é¡è‰² */
        .status-bar { height: 6px; width: 100%; }
        .bg-red { background: #ff6b6b; }     /* å¾…ç¹³è²» */
        .bg-yellow { background: #feca57; }  /* å¯©æ ¸ä¸­ */
        .bg-green { background: #1dd1a1; }   /* å·²å®Œæˆ */

        .bill-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .bill-body { padding: 15px 20px; }
        
        .row-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; color: #555; }
        .total-price { font-size: 1.3rem; font-weight: bold; color: #333; }
        
        .badge-status { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: normal;}
        
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-secondary">è®€å–å¸³å–®ç´€éŒ„ä¸­...</p>
    </div>

    <div class="container pt-4" id="app" style="display:none;">
        
        <div id="view-bind" style="display:none;">
            <div class="card shadow-sm mt-5">
                <div class="card-body p-4 text-center">
                    <h4>ğŸ‘‹ æ­¡è¿</h4>
                    <p class="text-muted">è«‹è¼¸å…¥èº«åˆ†è­‰å­—è™ŸæŸ¥è©¢</p>
                    <input type="text" id="input-nid" class="form-control form-control-lg mb-3 text-center" placeholder="A123456789" style="text-transform:uppercase;">
                    <button onclick="doBind()" class="btn btn-primary btn-lg w-100" id="btn-bind">æŸ¥è©¢ / ç¶å®š</button>
                </div>
            </div>
        </div>

        <div id="view-bills" style="display:none;">
            <h5 class="mb-3 ps-2 text-secondary">ğŸ“„ è¿‘æœŸå¸³å–®ç´€éŒ„</h5>
            <div id="bills-container">
                </div>
            
            <div id="empty-msg" class="text-center mt-5 text-muted" style="display:none;">
                å°šç„¡å¸³å–®ç´€éŒ„
            </div>
        </div>

    </div>

<script>
    // âš ï¸ è«‹å¡«å…¥ä½ çš„è¨­å®š
    const LIFF_ID = "2008820485-VKMYnG7d"; 
    const API_URL = "https://script.google.com/macros/s/AKfycbwRfFmfqVKSHMSHpGaqPFy9x8PLkFSf7cYuoyiFFtKFNA8ojXGtnkRUDWmMsft_MlP_/exec";

    let currentUser = null;
    let currentCommunityId = null; 

    window.onload = function() {
        liff.init({ liffId: LIFF_ID }).then(() => {
            if (!liff.isLoggedIn()) {
                liff.login({ redirectUri: window.location.href });
            } else {
                currentUser = liff.getDecodedIDToken().sub;
                fetchStatus();
            }
        });
    };

    function fetchStatus() {
        fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({ action: "getStatus", userId: currentUser })
        })
        .then(r => r.json())
        .then(res => {
            document.getElementById("loading").style.display = "none";
            document.getElementById("app").style.display = "block";

            if (!res.registered) {
                document.getElementById("view-bind").style.display = "block";
            } else {
                document.getElementById("view-bills").style.display = "block";
                
                // å„²å­˜ç¤¾å€ ID (ç¹³è²»è¦ç”¨)
                currentCommunityId = res.tenant.community_id;

                if (res.bills && res.bills.length > 0) {
                    renderBillsList(res.bills);
                } else {
                    document.getElementById("empty-msg").style.display = "block";
                }
            }
        });
    }

    // â˜… æ ¸å¿ƒæ”¹è®Šï¼šè¿´åœˆç”¢ç”Ÿå¤šå¼µå¡ç‰‡
    function renderBillsList(bills) {
        const container = document.getElementById("bills-container");
        container.innerHTML = ""; // æ¸…ç©º

        bills.forEach(bill => {
            // æ±ºå®šé¡è‰²èˆ‡ç‹€æ…‹æ–‡å­—
            let colorClass = "bg-red";
            let statusText = bill.status;
            let btnHtml = "";

            if (bill.status === "å¾…ç¹³è²»") {
                colorClass = "bg-red";
                // åªæœ‰å¾…ç¹³è²»æ‰é¡¯ç¤ºæŒ‰éˆ•
                btnHtml = `
                    <hr>
                    <button onclick="doPay('${bill.bill_id}')" class="btn btn-danger w-100">
                        ğŸ’° ç«‹å³ç¹³è²» $${formatMoney(bill.total)}
                    </button>`;
            } else if (bill.status === "å¾…æŸ¥æ ¸") {
                colorClass = "bg-yellow";
                statusText = "å¯©æ ¸ä¸­";
                btnHtml = `<div class="text-center mt-3 text-warning"><small>â³ æˆ¿æ±ç¢ºèªä¸­</small></div>`;
            } else if (bill.status === "å·²å®Œæˆ") {
                colorClass = "bg-green";
                statusText = "å·²ç¹³è²»";
                btnHtml = `<div class="text-center mt-3 text-success"><small>âœ… æ­¤å¸³å–®å·²çµæ¸…</small></div>`;
            }

            // è™•ç†ç‚º 0 çš„æ•¸å€¼é¡¯ç¤ºç‚º "-"
            const waterDisplay = Number(bill.water_amt) > 0 ? `$${formatMoney(bill.water_amt)} (${bill.water_usage}åº¦)` : "-";
            const elecDisplay = Number(bill.elec_amt) > 0 ? `$${formatMoney(bill.elec_amt)} (${bill.elec_usage}åº¦)` : "-";

            // å»ºç«‹å¡ç‰‡ HTML
            const cardHtml = `
            <div class="bill-card">
                <div class="status-bar ${colorClass}"></div>
                <div class="bill-header">
                    <h5 class="mb-0 fw-bold">${bill.month}</h5>
                    <span class="badge ${colorClass.replace('bg-', 'text-bg-')} badge-status">${statusText}</span>
                </div>
                <div class="bill-body">
                    <div class="row-item">
                        <span>ğŸ  æˆ¿ç§Ÿ</span>
                        <span>$${formatMoney(bill.rent)}</span>
                    </div>
                    <div class="row-item">
                        <span>ğŸ’§ æ°´è²»</span>
                        <span>${waterDisplay}</span>
                    </div>
                    <div class="row-item">
                        <span>âš¡ é›»è²»</span>
                        <span>${elecDisplay}</span>
                    </div>
                    <div class="row-item mt-3 pt-2 border-top">
                        <span class="fw-bold text-dark">ç¸½é‡‘é¡</span>
                        <span class="total-price ${bill.status==='å¾…ç¹³è²»'?'text-danger':''} ">$${formatMoney(bill.total)}</span>
                    </div>
                    ${btnHtml}
                </div>
            </div>`;

            container.innerHTML += cardHtml;
        });
    }

    // ç¶å®š
    function doBind() {
        const nid = document.getElementById("input-nid").value;
        if(!nid) return alert("è«‹è¼¸å…¥èº«åˆ†è­‰");
        document.getElementById("btn-bind").innerText = "è™•ç†ä¸­...";
        fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({ action: "bind", userId: currentUser, nationalId: nid })
        }).then(r=>r.json()).then(res => {
            if(res.success) { alert("æˆåŠŸï¼"); location.reload(); }
            else { alert(res.message); document.getElementById("btn-bind").innerText = "ç¶å®š"; }
        });
    }

    // ç¹³è²» (æ³¨æ„ï¼šç¾åœ¨ billId æ˜¯é€éåƒæ•¸å‚³é€²ä¾†çš„)
    function doPay(billId) {
        if(!confirm("ç¢ºèªå·²å®ŒæˆåŒ¯æ¬¾ï¼Ÿ")) return;
        // ç‚ºäº†ç°¡å–®ï¼Œé€™è£¡ä¸é–æŒ‰éˆ•ï¼Œç›´æ¥é€å‡º
        fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({ action: "pay", userId: currentUser, billId: billId, communityId: currentCommunityId })
        }).then(r=>r.json()).then(res => {
            if(res.success) { alert("å·²é€šçŸ¥æˆ¿æ±ï¼"); location.reload(); }
            else { alert("éŒ¯èª¤ï¼š" + res.message); }
        });
    }

    function formatMoney(num) {
        return Number(num).toLocaleString();
    }
</script>
</body>
</html>