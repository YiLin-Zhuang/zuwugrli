<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ç§Ÿå±‹ç®¡ç†ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js" data-cfasync="false"></script>
    
    <style>
        body { background-color: #f4f7f6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding-bottom: 90px; }
        
        /* å…±é€šæ¨£å¼ */
        .bill-card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; border: none; transition: transform 0.2s; }
        .bill-card:active { transform: scale(0.98); }
        .badge-pill { border-radius: 50px; padding: 5px 12px; font-size: 0.8rem; }
        
        /* ç‹€æ…‹è‰² */
        .status-red { color: #d63031; background: #fab1a050; }
        .status-yellow { color: #e17055; background: #ffeaa750; }
        .status-green { color: #00b894; background: #55efc450; }
        
        /* Loading */
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); z-index: 99999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .loading-card { background: rgba(255,255,255,0.85); backdrop-filter: blur(10px); padding: 40px; border-radius: 24px; text-align: center; animation: slideUp 0.6s ease-out; }
        
        /* åº•éƒ¨å°è¦½åˆ— */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); display: flex; justify-content: space-around; padding: 12px 0; z-index: 1000; border-radius: 20px 20px 0 0; }
        .nav-item { text-align: center; color: #b2bec3; font-size: 0.75rem; cursor: pointer; flex: 1; transition: 0.3s; }
        .nav-item i { font-size: 1.5rem; margin-bottom: 4px; display: block; }
        .nav-item.active { color: #0984e3; transform: translateY(-5px); }
        
        /* â˜… æˆ¿æ±å°ˆå±¬æ¨£å¼ */
        .stat-card { background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: white; border-radius: 20px; padding: 20px; margin-bottom: 25px; box-shadow: 0 10px 20px rgba(108, 92, 231, 0.3); }
        .tenant-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .tenant-avatar { width: 45px; height: 45px; background: #dfe6e9; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #636e72; font-weight: bold; margin-right: 15px; }
        
        /* è©³ç´°é  Modal æ•ˆæœ */
        #view-tenant-detail { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f4f7f6; z-index: 2000; overflow-y: auto; display: none; padding-bottom: 50px; animation: slideInRight 0.3s; }
        .detail-header { background: white; padding: 20px; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; align-items: center; }
        
        @keyframes slideUp { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }
        @keyframes slideInRight { from {transform:translateX(100%);} to {transform:translateX(0);} }
    </style>
</head>
<body>

    <div id="loading">
        <div class="loading-card">
            <i class="fa-solid fa-house-chimney fa-3x text-primary mb-3"></i>
            <div class="fw-bold text-secondary">è³‡æ–™åŒæ­¥ä¸­...</div>
        </div>
    </div>

    <div id="view-bind" class="container pt-5" style="display:none;">
        <div class="card border-0 shadow-lg p-4 text-center mt-5" style="border-radius: 20px;">
            <div class="mb-3"><i class="fa-solid fa-house-chimney-user fa-3x text-primary"></i></div>
            <h4>æ­¡è¿ä½¿ç”¨</h4>
            <p class="text-muted">è«‹è¼¸å…¥èº«åˆ†è­‰å­—è™Ÿé©—è­‰</p>
            <input type="text" id="input-nid" class="form-control form-control-lg mb-3 text-center bg-light border-0" placeholder="A123456789" style="text-transform:uppercase;">
            <button onclick="doBind()" class="btn btn-primary w-100 rounded-pill py-3">é–‹å§‹ç¶å®š</button>
        </div>
    </div>

    <div id="view-admin" style="display:none;">
        
        <div id="admin-tab-dash" class="container pt-4">
            <h4 class="fw-bold mb-3 ps-2">ğŸ‘‹ æˆ¿æ±æ‚¨å¥½</h4>
            
            <div class="stat-card">
                <div class="d-flex justify-content-between mb-3">
                    <span><i class="fa-solid fa-chart-pie me-2"></i>æœ¬æœˆæ¦‚æ³</span>
                    <span class="badge bg-white text-primary bg-opacity-25">çµ±è¨ˆä¸­</span>
                </div>
                <div class="row text-center">
                    <div class="col-6 border-end border-white border-opacity-25">
                        <small class="opacity-75">å·²æ”¶é‡‘é¡</small>
                        <h3 class="fw-bold mt-1" id="stat-collected">$0</h3>
                    </div>
                    <div class="col-6">
                        <small class="opacity-75">å¾…æ”¶é‡‘é¡</small>
                        <h3 class="fw-bold mt-1" id="stat-pending">$0</h3>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-3 px-2">
                <h6 class="fw-bold text-secondary mb-0">å¾…è™•ç†äº‹é …</h6>
                <button onclick="triggerAutoBill()" class="btn btn-sm btn-light rounded-pill text-primary fw-bold"><i class="fa-solid fa-wand-magic-sparkles me-1"></i>è‡ªå‹•å‡ºå¸³</button>
            </div>
            
            <div id="admin-todo-list"></div>
            <div id="admin-todo-empty" class="text-center mt-5 text-muted" style="display:none;">
                <i class="fa-regular fa-calendar-check fa-3x mb-3 text-success"></i><p>ç›®å‰æ²’æœ‰å¾…å¯©æ ¸é …ç›®</p>
            </div>
        </div>

        <div id="admin-tab-tenants" class="container pt-4" style="display:none;">
            <h5 class="fw-bold mb-3 ps-2">ç§Ÿå®¢ç®¡ç†</h5>
            <div class="card border-0 shadow-sm" style="border-radius: 16px;">
                <div id="tenant-list-container"></div>
            </div>
        </div>

        <div id="admin-tab-news" class="container pt-4" style="display:none;">
            <h5 class="fw-bold mb-3 ps-2">ç™¼å¸ƒå…¬å‘Š</h5>
            <div class="text-center mt-5 pt-5 text-muted">
                <i class="fa-solid fa-bullhorn fa-3x mb-3 text-secondary"></i>
                <p>å…¬å‘Šæ¨æ’­åŠŸèƒ½é–‹ç™¼ä¸­...</p>
                <small>æœªä¾†å¯åœ¨æ­¤ç™¼é€åœæ°´åœé›»é€šçŸ¥çµ¦æ‰€æœ‰æˆ¿å®¢</small>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchAdminTab('dash', this)">
                <i class="fa-solid fa-table-columns"></i><span>ç¸½è¦½</span>
            </div>
            <div class="nav-item" onclick="switchAdminTab('tenants', this)">
                <i class="fa-solid fa-users"></i><span>ç§Ÿå®¢</span>
            </div>
            <div class="nav-item" onclick="switchAdminTab('news', this)">
                <i class="fa-solid fa-bell"></i><span>å…¬å‘Š</span>
            </div>
        </div>
    </div>

    <div id="view-tenant-detail">
        <div class="detail-header">
            <button onclick="closeDetail()" class="btn btn-light rounded-circle me-3"><i class="fa-solid fa-arrow-left"></i></button>
            <h5 class="mb-0 fw-bold" id="detail-title">ç§Ÿå®¢æ­·å²</h5>
        </div>
        <div class="container pt-3" id="detail-history-list">
            </div>
    </div>


    <div id="app-main" style="display:none;">
        <div id="tab-home" class="container pt-3">
            <h5 class="fw-bold mb-3 ps-1">æˆ‘çš„å¸³å–®</h5>
            <div id="current-bills-container"></div>
            <div id="home-empty" class="text-center mt-5 text-muted" style="display:none;"><p>ç„¡å¾…ç¹³å¸³å–®</p></div>
        </div>
        </div>

<script>
    const LIFF_ID = "2008820485-VKMYnG7d"; 
    const API_URL = "https://script.google.com/macros/s/AKfycbwRfFmfqVKSHMSHpGaqPFy9x8PLkFSf7cYuoyiFFtKFNA8ojXGtnkRUDWmMsft_MlP_/exec";
    
    let currentUser = null;

    window.onload = function() {
        if (typeof liff === 'undefined') { document.getElementById("loading").style.display = "none"; alert("SDK Error"); return; }
        liff.init({ liffId: LIFF_ID }).then(() => {
            if (!liff.isLoggedIn()) liff.login({ redirectUri: window.location.href });
            else {
                currentUser = liff.getDecodedIDToken().sub;
                fetchStatus();
            }
        });
    };

    function fetchStatus() {
        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getStatus", userId: currentUser }) })
        .then(r => r.json()).then(res => {
            document.getElementById("loading").style.display = "none";
            if (res.isAdmin) initLandlordView();
            else if (res.registered && res.tenant) initTenantView(res); // å‘¼å«æˆ¿å®¢æ¸²æŸ“
            else document.getElementById("view-bind").style.display = "block";
        });
    }

    // --- æˆ¿æ±é‚è¼¯ ---
    function initLandlordView() {
        document.getElementById("view-admin").style.display = "block";
        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getLandlordData" }) })
        .then(r => r.json()).then(res => {
            renderDashboard(res.data.list, res.data.stats);
            renderTenantList(res.data.list);
        });
    }

    function renderDashboard(list, stats) {
        // æ›´æ–°çµ±è¨ˆå¡
        document.getElementById("stat-collected").innerText = "$" + formatMoney(stats.collected);
        document.getElementById("stat-pending").innerText = "$" + formatMoney(stats.total_rent - stats.collected);
        
        // æ›´æ–°å¾…è¾¦äº‹é …
        const container = document.getElementById("admin-todo-list");
        container.innerHTML = "";
        let hasTodo = false;

        list.forEach(item => {
            if (item.bill.status === "å¾…æŸ¥æ ¸") {
                hasTodo = true;
                container.innerHTML += `
                <div class="bill-card p-3 border-start border-5 border-warning">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="fw-bold mb-1">${item.tenant.community_id} <span class="text-muted small">(${item.tenant.name})</span></h6>
                            <small class="text-muted">${item.bill.month} å¸³å–®</small>
                        </div>
                        <span class="badge status-yellow badge-pill">å¾…æŸ¥æ ¸</span>
                    </div>
                    <button onclick="verifyPayment('${item.tenant.community_id}', '${item.bill.bill_id}')" class="btn btn-primary w-100 mt-3 rounded-pill shadow-sm">
                        ç¢ºèªæ”¶æ¬¾ $${formatMoney(item.bill.total)}
                    </button>
                </div>`;
            }
        });
        if(!hasTodo) document.getElementById("admin-todo-empty").style.display = "block";
    }

    function renderTenantList(list) {
        const container = document.getElementById("tenant-list-container");
        container.innerHTML = "";
        list.forEach(item => {
            // é»æ“Šç§Ÿå®¢åˆ—ï¼Œé–‹å•Ÿè©³ç´°é 
            container.innerHTML += `
            <div class="tenant-row" onclick="openTenantDetail('${item.tenant.community_id}', '${item.tenant.name}')">
                <div class="d-flex align-items-center">
                    <div class="tenant-avatar">${item.tenant.community_id.substring(0,2)}</div>
                    <div>
                        <div class="fw-bold">${item.tenant.community_id}</div>
                        <div class="text-muted small">${item.tenant.name}</div>
                    </div>
                </div>
                <i class="fa-solid fa-chevron-right text-muted opacity-25"></i>
            </div>`;
        });
    }

    // é–‹å•Ÿè©³ç´°é 
    function openTenantDetail(communityId, name) {
        document.getElementById("detail-title").innerText = `${communityId} (${name})`;
        document.getElementById("view-tenant-detail").style.display = "block";
        document.getElementById("detail-history-list").innerHTML = '<div class="text-center mt-5"><span class="spinner-border text-primary"></span></div>';
        
        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getTenantHistory", communityId }) })
        .then(r => r.json()).then(res => {
            const container = document.getElementById("detail-history-list");
            container.innerHTML = "";
            res.history.forEach(bill => {
                let badge = bill.status === "å·²å®Œæˆ" ? '<span class="badge status-green badge-pill">å·²ç¹³è²»</span>' : '<span class="badge status-red badge-pill">æœªç¹³</span>';
                container.innerHTML += `
                <div class="bill-card p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="fw-bold mb-0">${bill.month}</h6>
                        ${badge}
                    </div>
                    <hr class="my-2 opacity-10">
                    <div class="d-flex justify-content-between"><small class="text-muted">ç¸½é‡‘é¡</small><span class="fw-bold">$${formatMoney(bill.total)}</span></div>
                </div>`;
            });
        });
    }

    function closeDetail() {
        document.getElementById("view-tenant-detail").style.display = "none";
    }

    function switchAdminTab(tab, el) {
        document.getElementById("admin-tab-dash").style.display = "none";
        document.getElementById("admin-tab-tenants").style.display = "none";
        document.getElementById("admin-tab-news").style.display = "none";
        document.getElementById("admin-tab-" + tab).style.display = "block";
        
        document.querySelectorAll(".bottom-nav .nav-item").forEach(item => item.classList.remove("active"));
        el.classList.add("active");
    }

    // é©—æ”¶èˆ‡è‡ªå‹•å‡ºå¸³ (èˆ‡ä¹‹å‰ç›¸åŒ)
    function verifyPayment(cid, bid) {
        if(!confirm("ç¢ºèªæ”¶æ¬¾ï¼Ÿ")) return;
        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "verify", communityId: cid, billId: bid }) })
        .then(() => { alert("å·²æ”¶æ¬¾"); initLandlordView(); });
    }
    
    function triggerAutoBill() {
        if(!confirm("åŸ·è¡Œè‡ªå‹•å‡ºå¸³ï¼Ÿ")) return;
        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "triggerAutoBill" }) })
        .then(r=>r.json()).then(res => alert(res.message));
    }

    // --- æˆ¿å®¢é‚è¼¯ (ç²¾ç°¡ç‰ˆï¼Œè«‹ä¿ç•™ä½ åŸæœ¬çš„å®Œæ•´ç‰ˆ) ---
    function initTenantView(res) {
        document.getElementById("app-main").style.display = "block";
        const container = document.getElementById("current-bills-container");
        if(res.bills) {
            res.bills.forEach(bill => {
                 // é€™è£¡è«‹å¡«å…¥ä½ åŸæœ¬æ¼‚äº®çš„æˆ¿å®¢å¡ç‰‡ HTML
                 container.innerHTML += `<div class="bill-card p-3">...æˆ¿å®¢å…§å®¹...</div>`;
            });
        }
    }

    function doBind() { /* ...ç¶å®šé‚è¼¯... */ }
    function formatMoney(n) { return Number(n).toLocaleString(); }
</script>
</body>
</html>